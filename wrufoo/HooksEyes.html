<!doctype html>
<html lang="en">
<head>
    <title> HookEyes </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!--
    <link rel=stylesheet href="css/base.css"/>
-->
</head>
<body>

    Nothing to see here. Open the console.
<!-- ------------------------------------------------------------ -->
<!--
<script src="../build/Three.js"></script>
<script src="../examples/js/controls/OrbitControls.js"></script>
<script src="libs/DAT.GUI.min.js"></script>
<div id="ThreeJS" style="z-index: 0; position: absolute; left:0px; top:0px"></div>  
------------------------------------------------------------ -->
<script>
'use strict';

var objectID = function( ) { // open IIFE
  var objectIDglobal = 100;
  return function( prefix )
  {
    var z = objectIDglobal;
    objectIDglobal += 1;
    if( prefix === undefined )
    {
        prefix = ''
    }
    return prefix + z;
  }
}();  // close IIFE

//console.log( objectID('TST') );

function trueMod( i, n )
{
    return ( i % n + n ) % n
}

console.assert( trueMod( -3, 5 ) === 2, 'trueMod' );
console.assert( trueMod(  3, 5 ) === 3, 'trueMod' );


function Vertex( figure )
{
    this.id = objectID( 'V' )
    this.figure = figure;
    this.length = figure.length;
    this.faces = new Array( this.length );
    this.corners = new Array( this.length );

    this.iNeg  = 0;
    this.iPos  = 0;
}
// Invariants:
//    -length <= iNeg <= 0 <= iPos <= length
//    init: iNeg == 0, iPos == 0
//    slots in use: iPos - iNeg
//    slots free:  length - iPos + iNeg
//    slot i is assigned IFF iNeg <= i && iPos < i

Vertex.prototype.face = function( i )
{
    return this.faces[ trueMod( i, this.length ) ];
}

Vertex.prototype.corner = function( i )
{
    return this.corners[ trueMod( i, this.length ) ];
}

Vertex.prototype.addCornerNeg = function( aFace, aCorner )
{
      var i = trueMod(this.iNeg - 1, this.length);
      this.faces[ i ] = aFace;
      this.corners[ i ] = aCorner;
      this.iNeg -= 1;
      
      var j = trueMod( aCorner, aFace.vertices.length );
      aFace.vertices[ j ] = this;
      aFace.slots[ j ] = i;

      return i;
}

Vertex.prototype.addCornerPos = function( aFace, aCorner )
{
      var slot = this.iPos;
      this.faces[ this.iPos ] = aFace;
      this.corners[ this.iPos ] = aCorner;

      var j = trueMod( aCorner, aFace.vertices.length );
      aFace.vertices[ j ] = this;
      aFace.slots[ j ] = slot;
      
      this.iPos += 1;

      return slot;
}

Vertex.prototype.show = function( label )
{
    console.log( '\n' + label, 'id: ' + this.id, '  iNeg: ' + this.iNeg, '  iPos: ' + this.iPos );
    var i;
    for( i = this.iNeg; i < this.iPos; i += 1 )
    {
      var ii = trueMod( i, this.length );
      //console.log( ii, this.figure[ii], this.faces[ii].id, this.corners[ii] );
      console.log( ii + ': ' + this.figure[ii] + ' ' + this.faces[ii].id + '[ ' + this.corners[ii] + ' ]' );
    }
}

var testVertex = new Vertex( [3,2,3,2,3] ); //console.log( 'testVertex', testVertex );

/**********************************************************
console.log( "starting");
 testVertex.show();
testVertex.addCornerPos( 'foo', 'a' );
 testVertex.show();
testVertex.addCornerNeg( 'foo', 'z' );
 testVertex.show();
testVertex.addCornerPos( 'foo', 'b' );
 testVertex.show();
testVertex.addCornerNeg( 'foo', 'y' );
 testVertex.show();
testVertex.addCornerNeg( 'foo', 'x' );
 testVertex.show();

console.log( "unstarting");

 console.log( 'testVertex', testVertex );

console.assert( testVertex.corner(-2) === testVertex.corner( 3 ) );

**********************************************************/

function Face( nSides )
{
  this.id = objectID( 'F' );
  this.vertices = Array( nSides );
  this.slots = Array( nSides );
  this.nSides = nSides;
}

Face.prototype.show = function( label )
{
    console.log( '\n' + label, 'id: ' + this.id, ' nSides: ' + this.nSides );
    var i;
    for( i = 0; i < this.nSides; i += 1 )
    {
      var v_i = this.vertices[ i ];
      var s_i = this.slots[ i ];
      if( v_i !== undefined ) {
          console.log( i + ': ', v_i.id + '[ ' + s_i + ' ]' );
      }
    }
}
// var testFace = new Face( 3 );  testFace.show( 'foo' );

Face.prototype.vertex = function( i )
{
    return this.vertices[ trueMod( i, this.nSides ) ];
}

function ensureVertex( aFace, aCornerIndex, figure )
{
    var i = trueMod( aCornerIndex, aFace.nSides ); 
    var vZ = aFace.vertices[ i ];
    if( vZ === undefined ) {
        vZ = new Vertex( figure ) ;
        aFace.vertices[ i ] = vZ;
        var si = vZ.addCornerPos( aFace, aCornerIndex );
        aFace.slots[ i ] = si;
    }
    return vZ;
}

var testFace = new Face( 4 );
var vv = ensureVertex( testFace, 2, [3,4,3,4] );
//testFace.show( 'vv' );  vv.show( 'vv' );

function connectEdges( fx, cx, fy, cy, figure )
{
    var v_fxcx = fx.vertex( cx );
    var v_fycy = fy.vertex( cy );
    if( v_fxcx === undefined && v_fycy === undefined ){
//      v_fxcx = ensureVertex( fx, cx, figure ); v_fxcx.addCornerNeg( fy, cy ); 
        v_fxcx = ensureVertex( fx, cx, figure ).addCornerNeg( fy, cy ); 
    }

    var v_fxcxp1 = fx.vertex( cx + 1 );
    var v_fycym1 = fy.vertex( cy - 1 );
    if( v_fxcxp1 === undefined && v_fycym1 === undefined ){
        v_fxcxp1 = ensureVertex( fx, cx + 1, figure );
        v_fxcxp1.addCornerPos( fy, cy - 1 ); 
    }
//    console.log( 'v_fxcx', v_fxcx );
//    console.log( 'v_fycy', v_fycy );
//    console.log( 'v_fxcxp1', v_fxcxp1 );


}

var aFig = [ 4,3,4,3 ];
var fa = new Face( 4 );
var fb = new Face( 3 );

connectEdges( fa, 0, fb, 0, aFig ) ;
fa.show( 'fa' );
fb.show( 'fb' );
fa.vertex(0).show( 'fa.v[0] ' );
fb.vertex(0).show( 'fb.v[0] ' );
fa.vertex(1).show( 'fa.v[1] ' );
fb.vertex(-1).show( 'fb.v[-1] ' );





function fooBuild( figure )
{
  console.log( '\nfooBuild', figure );

  // The initial face
    var iVslot = 0;
    var nSides = figure[ iVslot ] ;
    var f_0 = new Face( nSides );

  // Begin at corner 0 of the initial face.
  // Add a second face to the vertex after(CCW) the initial face  
    var v_0 = ensureVertex( f_0, 0, figure );
    console.assert( v_0.iPos === 1 && v_0.iNeg === 0 );

    var nCorners  = v_0.figure[ v_0.iPos ];
    var f_i = new Face( nCorners );
  // Connect corner 0 of the face to the vertex
    v_0.addCornerPos( f_i, 0 );

  // Connect the next corner of the second face to the previous corner of the first face. 
    var v_prev = ensureVertex( f_0, -1, figure );
    v_prev.addCornerNeg( f_i, 1 );

    f_0.show( 'f_0' );
    f_i.show( 'f_i' );

    v_0.show( 'v_0' );
    v_prev.show( 'v_prev' );

}  

/////////////fooBuild( [4, 3, 4, 3 ] );

/******************************************************
************************************/

//////////////////////////////////////////////////////
// OLD STUFF
/////////////////////////////////////////////////////

</script>
</body>
</html>
